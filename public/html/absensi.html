<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Staf - Djingga Coffe</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden">
        <div class="bg-blue-600 p-6 text-white text-center">
            <h1 class="text-2xl font-bold">Absensi Digital</h1>
            <p class="text-blue-100 text-sm">Sobat Kasir Pro - Area Toko</p>
        </div>

        <div class="p-6 space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Nama Anda</label>
                <select id="nama-staf" class="w-full p-3 border-2 border-gray-100 rounded-lg outline-none focus:border-blue-500 bg-gray-50">
                    <option value="">-- Pilih Staf --</option>
                    <option value="Nita">Nita (Kasir 1)</option>
                    <option value="Michele">Michele (Kasir 2)</option>
                    <option value="Afif">Afif (Admin)</option>
		    <option value="Wachid">Wachid (Kitchen)</option>

                </select>
            </div>

            <div id="location-status" class="p-4 rounded-lg bg-yellow-50 border border-yellow-200 flex items-center gap-3">
                <div class="animate-pulse w-3 h-3 bg-yellow-400 rounded-full"></div>
                <p class="text-sm text-yellow-700 font-medium">Mengecek lokasi Anda...</p>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <button onclick="prosesAbsen('Masuk')" id="btn-masuk" disabled 
                    class="bg-green-600 text-white py-4 rounded-xl font-bold opacity-50 cursor-not-allowed hover:bg-green-700 transition shadow-lg">
                    ABSEN MASUK
                </button>
                <button onclick="prosesAbsen('Pulang')" id="btn-pulang" disabled 
                    class="bg-red-600 text-white py-4 rounded-xl font-bold opacity-50 cursor-not-allowed hover:bg-red-700 transition shadow-lg">
                    ABSEN PULANG
                </button>
            </div>

            <a href="index.html" class="block text-center text-sm text-gray-400 hover:text-blue-500 underline">Kembali ke Kasir</a>
        </div>
    </div>

    <script>
        // --- KONFIGURASI ---
        const SUPABASE_URL = 'https://omelevfdcdpjxvqfashr.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_v0g8OjJUHlw7iHZhzngEaw_6Qwgx5gW';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // KOORDINAT TOKO (Ganti dengan koordinat toko kamu dari Google Maps)
        const TOKO_LAT = -7.767370431299227; 
        const TOKO_LON = 110.34791051534232;
        const RADIUS_MAX = 100; // Meter

        let userLat, userLon, currentDistance;

        // --- FUNGSI HITUNG JARAK (HAVERSINE) ---
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Radius bumi dalam meter
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // --- MONITOR LOKASI ---
        function trackLocation() {
            if (!navigator.geolocation) {
                alert("Browser tidak mendukung GPS");
                return;
            }

            // Ganti baris navigator.geolocation.watchPosition dengan ini
navigator.geolocation.watchPosition((pos) => {
    userLat = pos.coords.latitude;
    userLon = pos.coords.longitude;
    currentDistance = calculateDistance(userLat, userLon, TOKO_LAT, TOKO_LON);

    const statusDiv = document.getElementById('location-status');
    const btnMasuk = document.getElementById('btn-masuk');
    const btnPulang = document.getElementById('btn-pulang');

    if (currentDistance <= RADIUS_MAX) {
        statusDiv.className = "p-4 rounded-lg bg-green-50 border border-green-200 flex items-center gap-3";
        statusDiv.innerHTML = `<div class="w-3 h-3 bg-green-500 rounded-full"></div>
                               <p class="text-sm text-green-700 font-medium">Anda di area toko (${Math.round(currentDistance)}m)</p>`;
        btnMasuk.disabled = false; btnMasuk.classList.remove('opacity-50', 'cursor-not-allowed');
        btnPulang.disabled = false; btnPulang.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
        statusDiv.className = "p-4 rounded-lg bg-red-50 border border-red-200 flex items-center gap-3";
        statusDiv.innerHTML = `<div class="w-3 h-3 bg-red-500 rounded-full"></div>
                               <p class="text-sm text-red-700 font-medium">Terlalu Jauh! Jarak: ${Math.round(currentDistance)}m</p>`;
        btnMasuk.disabled = true; btnMasuk.classList.add('opacity-50', 'cursor-not-allowed');
        btnPulang.disabled = true; btnPulang.classList.add('opacity-50', 'cursor-not-allowed');
    }
}, (err) => {
    // TAMBAHKAN LOG ERROR BIAR KITA TAHU KENAPA GAGAL
    const statusDiv = document.getElementById('location-status');
    statusDiv.innerHTML = `<p class="text-sm text-red-600">Gagal ambil lokasi: ${err.message}</p>`;
}, { 
    enableHighAccuracy: true, // WAJIB biar akurat
    timeout: 10000,           // Nunggu maksimal 10 detik
    maximumAge: 0             // Jangan pakai lokasi lama (cache)
});
        }

       async function prosesAbsen(tipe) {
    const nama = document.getElementById('nama-staf').value;
    if (!nama) return alert("Pilih nama dulu, Sob!");

    // Kirim data ke tabel 'absensi' (bukan attendance)
    const { error } = await supabaseClient.from('absensi').insert([{
        nama_staf: nama, // Sesuai kolom di database kamu
        status: tipe,
        jarak_meter: currentDistance,
        koordinat: `${userLat},${userLon}`
        // created_at tidak perlu diisi karena otomatis oleh Supabase
    }]);

    if (!error) {
        alert(`Berhasil Absen ${tipe}!`);
        window.location.href = "dashboard.html";
    } else {
        alert("Gagal simpan: " + error.message);
    }
}

        // Jalankan pelacakan lokasi saat halaman dibuka
        trackLocation();
    </script>
</body>
</html>